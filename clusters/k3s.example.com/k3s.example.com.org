#+title: Literate K3s Cluster
#+author: EnigmaCurry
#+OPTIONS: ^:{}
#+EXPORT_FILE_NAME: index.html
#+INCLUDE: "../../meta/export-html.org"
#+INCLUDE: "../../meta/github-ribbon.org"
#+INCLUDE: "../../meta/intro.org"
# Local Variables:
# eval: (progn (load-file "../../meta/org-meta.el"))
# End:

* Create directories
Create all of the directories necessary for tangling this config. (These are always re-iterated
in the individual configs, but this gets you going quicker):

#+begin_src shell :noweb yes :eval never-export :exports code
mkdir -p <<SRC_DIR>>/kube-system/traefik
mkdir -p <<SRC_DIR>>/git-system/gitea
mkdir -p <<SRC_DIR>>/flux-system
#+end_src

* Core Config
** CLUSTER
  =CLUSTER= is the domain name of your cluster:
  #+name: CLUSTER
  #+begin_src config :noweb yes :eval no
  k3s.example.com
  #+end_src
** CLUSTER_SSH_USER
   =CLUSTER_SSH_USER= is the admin SSH account of the cluster.
   #+name: CLUSTER_SSH_USER
   #+begin_src config :noweb yes :eval no
   root
   #+end_src
** SRC_DIR
=SRC_DIR= is an absolute path reference to the current directory that contains
this file. It is also the destination directory for tangling. If you cloned the
repository to a path structure other than the suggestion in the introduction
guide, you should update this variable accordingly, /however/, don't change this
to directory to anything other than the one that contains this file, because
org-mode is not configured for tangling to any other directory.

#+name: SRC_DIR
#+begin_src config :noweb yes :eval no
${HOME}/git/literate-k3s/clusters/<<CLUSTER>>
#+end_src

** KUBE_CONFIG
  =KUBE_CONFIG= is the local path to the kubectl config file
  #+name: KUBE_CONFIG
  #+begin_src config :noweb yes :eval no
  ${HOME}/.kube/<<CLUSTER>>-config
  #+end_src
** kubectl command
 Since you'll need to specify the kubectl config file each and every time you use
 =kubectl=, let's create a NoWeb alias for it (=<<kubectl>>=), to use in other
 code blocks.
 #+name: kubectl
 #+begin_src config :noweb yes :eval no
 kubectl --kubeconfig=<<KUBE_CONFIG>>
 #+end_src

* kube-system
=kube-system= is the namespace for running system wide features, mostly network
related. 
#+INCLUDE: "../../lib/traefik.org"
#+INCLUDE: "../../lib/sealed_secrets.org"
* git-system
=git-system= is the namespace created for Gitea.
#+INCLUDE: "../../lib/gitea.org"
* flux-system
#+INCLUDE: "../../lib/flux.org"
* LICENSE
#+INCLUDE: "../../LICENSE.org"
